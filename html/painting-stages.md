# стадии отрисовки страницы

- Браузер получает HTML-страницу. HTML парсится и разбивается на токены
- Токены преобразуются в ноды
- Ноды собираются в dom DOM (или DOM-дерево) - это представление страницы в памяти компьютера
- Скачиваются все внешние ресурсы
- Параллельно происходит парсинг CSS, выстраивается CSSOM
- CSSOM и DOM объединяются в Render-tree, в котором скрываются невидимые элементы meta, script, link и добавляются псевдоэлементы before, after
- создается render tree / style calculation «формированием дерева представления» или «формированием дерева рендеринга»
- Переход на стадию Layout, Reflow, Repaint, Composition

![отрисовка страницы](../css/css-assets/page-parsing-stages.png)

Первая стадия это Layout -> Reflow -> Composition

- **layout** отвечает за определение размеров элементов и как их располагать на экране, это самая тяжелая операция для браузера

- **Reflow** – происходит, когда мы изменяем элементы на экране, могут быть изменены как отдельные ветки, так и все дерево именно поэтому документ должен иметь наиболее плоскую структуру. Так же Reflow происходит когда мы снимаем метрики с помощью getBoundingClientRect, offsetLeft, offsetRight. Reflow происходит в основном потоке браузера, там и где крутится event loop, так что на этой стадии JS будет заблокирован

- **Repaint** – на этом этапе браузер обходит layout tree и перекрашивает элементы, как правило Reflow вызывает Repaint

- **Composite** – группировка элементов по слоям, отрисовывает то, что находится не в основном потоке. Все анимации выносятся в отдельный слой, вычисляется в отбельном потоке и JS никак не влияет на него

- **Update** вызывается с помощью getBoundingClientRect()

Вызов repaint

- изменение окна, изменение ориентации
- изменение шрифта
- изменение контента, размера
- добавление/удаление классов стилей
- манипуляции с DOM
- вычисление размеров

# Метрики страницы

- **FCP** – first contentful paint (первая отрисовка) выделять критический css (главное метрика)
- **LCP** – largest contentful paint (отрисовка самого большого элемента) равен FCP без картинок и без критических стилей, выделять height и width для картинки. Убивают видео и фреймы. Можно вставить прямоугольник или картинку, но появляется потенциальная проблема оптимизации
- **TTI** – time to interactive
- **CLS** – Cumulative layout shift (сдвиг от первоначального) правильно выделять критический css
- **TBT** – total blocking time – время, которое нужно для обработки первого действия пользователя
- **SI** – speed index

!!! Браузер автоматически сокращает любое количество пробелов до одного
!!! больше 4гб не выделяется на вкладку
