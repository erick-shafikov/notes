# кеширование

Виды:

- приватные - для отдельного пользователя в браузере, используется для навигации назад-вперед. При первом запросе страница скачивается в кеш браузера, а последующие запросы возвращают кешированную копию. Управляется заголовком Expires со значением даты когда кеш становится невалидным
- совместного пользования - кеш на прокси, провайдер кеширует данные
- реверсивный прокси сервер - при использовании динамические страницы с запросами на сервер и бд, он кеширует страницы с одинаковыми данными

Уровни кеширования:

- Кэши приложений и баз данных
- Кэши на уровне обратного прокси
- Сервис-воркеры

Кешируют только get-запросы:

- с ответом 200 ок get на запрос html, картинок, файлов
- 301
- 404
- 206

Управление осуществляется заголовком Cache-control:

- со значениями:
- - no-store - нельзя хранить страницу
- - no-cache - перед показом копии узнать изменилась ли
- - must-revalidate
- приватный/не - private, public - на прокси и браузере
- время - max-age=31536000
- актуальность must-revalidate

Conditional get запрос позволяет узнать изменился ли ресурс, управляется тегом

- ETag - токен содержимого файла, у одинаковых файлов он одинаковый, если нужно проверить, то браузер добавляет заголовок:
- - if-none-match со значением ETag-хеша
- - if-modified-since - с датой изменения
- - Слабый ETag - ETag: W/"abc123"
- - Сильный ETag - ETag: "abc123"

```bash
GET /users/42 HTTP/1.1 #запрос

# ответ от сервера
HTTP/1.1 200 OK
ETag: "v3-users-42"
Cache-Control: private

# Повторный запрос (условный)
GET /users/42 HTTP/1.1
If-None-Match: "v3-users-42" # сравнивает If-None-Match с текущим ETag ресурса

HTTP/1.1 304 Not Modified # Если ресурс НЕ изменился

# Если ресурс изменился
HTTP/1.1 200 OK
ETag: "v4-users-42"
```

- Vary - Ответ для этого URL зависит от значений указанных заголовков запроса, так как ответ может отличаться по языку, сжатию, формату, авторизации, user-agent

Если ресурс не изменился то отправляется 304 not modified + заголовки, если ресурс изменился - 200

# BFCache

Полный снимок DOM Для кнопок назад-вперед, не обращается к HTTP-кэшу

# Спекулятивная и предварительная загрузка

- Prefetch
- Preload
- Prerender
- Speculation rules API

# BP

## файлы и документы

```bash
# Статические ресурсы (JS, CSS, шрифты). Цель: отдавать мгновенно, повторно не проверять, безопасно кэшировать на протяжении долгого времени.
Cache-Control: public, max-age=31536000, immutable

# HTML-документы  часто меняющийся контент (новости, главные страницы)
Cache-Control: public, max-age=60, s-maxage=300, stale-while-revalidate=60, stale-if-error=600
ETag: "abc123"

# HTML-документы, редко меняющийся контент (блоги, документация):
Cache-Control: public, max-age=300, s-maxage=86400, stale-while-revalidate=300, stale-if-error=3600
ETag: "abc123"

# Персонализированные страницы (для авторизованных пользователей):
Cache-Control: private, no-cache
ETag: "abc123"
```

## api

```bash
# Цель: обеспечить баланс между актуальностью данных, производительностью и отказоустойчивостью.

Cache-Control: public, s-maxage=30, stale-while-revalidate=30, stale-if-error=300
ETag: "def456"

# Аутентифицированные панели управления и страницы с персонализированным контентом. Цель: не допустить кэширования на общих уровнях, но разрешить повторное использование в браузере.
Cache-Control: private, no-cache
ETag: "ghi789"
```

## Изображения и медиа

```bash
# Цель: эффективно хранить в кэше разные версии для разных устройств, отдавая нужный вариант.
Cache-Control: public, max-age=86400
Vary: Accept-Encoding, DPR, Width
```
