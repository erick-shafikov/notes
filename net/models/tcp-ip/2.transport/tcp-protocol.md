# tcp

tcp - transmission control protocol, обеспечивает передачу байтов, устанавливает сетевое соединение, нужно устанавливать соединение. Надежная передача данных - потеря, нарушение порядка, дублирование. Надежность обеспечивается за счет подтверждения получений. По таймеру отправляются данные опять, если нет подтверждение. Если не дошло подтверждение, то данные отправляется заново

Перед отправкой устанавливает соединение - договариваются о нумерации, параметрах. После завершения соединение разрывается

# структура

Транспортная подсистема получает поток байт, который делится на сегменты. Эти сегменты передаются . Получатель собирает сегменты в поток байт. Сегменты имеют номера. Сегменты - по 1024 байт. В подтверждение отправляется следующую порцию байт (следующий номер). Таким образом оба участника передачи могут контролировать потерю и дублирование

Формат заголовка:

- порт отправителя - адреса на транспортном уровне
- порт получателя - адреса на транспортном уровне
- порядковый номер - первый байт в сегменте
- номер подтверждения - номер подтверждения
- смещение
- флаги - FIN, ACK, SYN
- размер окна
- контрольная сумма
- указатель на срочные данные
- параметры - максимум данных, метки времени, SACK, масштаб окна
- данные

# соединение

Процесс передачи данных:

- установка соединения - что бы убедится, что соединение нужно, синхронизация потока байт, определить параметры соединения. На первом этапе передается заголовок SYNC 7537 байт. Получатель отправляет подтверждение 7537, оправляет ожидаемую. порцию байт. За три шага договариваются о передачи байт. Если бы все было 0, то при разрыве соединение могли бы дублироваться. Трехкратное рукопожатие SYN, SYN + ACK, ACK
- передача данных
- разрыв соединения - отправитель разрывает соединение с флагом FIN, получатель разрывают. Или RST для разрыва соединение

Варианты подтверждения доставки:

- остановка и ожидание - канальный уровень, отправляется данные, получает подтверждение соединение останавливается
- Скользящее окно - транспортный уровень. Передается порциями как подтверждение так и сам запрос. Размер окна - кол-во байт данных неподтвержденных

типы подтверждения:

- кумулятивное - все предыдущие байты не включая предыдущие (по молчанию)
- выборочное (selective acknowledgment sack)- подтверждения диапазонов

Состояния соединения:

- LISTEN - сервер слушает и ждет подключения
- SYN-SENT - в процессе установке соединения
- ESTABLISH - соединение
- FIN-WAIT, FIN-WAIT-2, CLOSING, LAST-ACK, TIME-WAIT, CLOSED - ожидание и закрытие соединения

# управление потоком

если получатель имеет более низкую пропускную способность нежели отправитель то может возникнуть "затопление". При получении хост записывает в буфер, этот буфер может закончится. Это контролируется размером окна. Оно контролируется буфером. При переполнении окна, отправляется окно размером 0. Отправитель выставляет таймер и по окончанию этого таймер отправляет запрос на освободилось ли окно
