# парсинг страницы

- Браузер получает HTML-страницу. HTML парсится и разбивается на токены
- Токены преобразуются в ноды
- Ноды собираются в dom DOM (или DOM-дерево) - это представление страницы в памяти компьютера
- Во время прохождения по DOM браузер встречает скрипты и таблицы стилей. Скачиваются все внешние ресурсы
- Параллельно происходит парсинг CSS, выстраивается CSSOM
- CSSOM и DOM объединяются в Render-tree, в котором скрываются невидимые элементы meta, script, link, display:none и добавляются псевдоэлементы before, after
- CSSOM и DOM формируются в основном потоку
- создается render tree / style calculation «формированием дерева представления» или «формированием дерева рендеринга»
- Переход на стадию Layout, Reflow, Repaint, Composition

# стадии отрисовки страницы

Первая цикл стадий это Layout -> Reflow -> Composition.

Стадии:

- layout (Reflow) - стадия компоновки, отвечает за определение размеров элементов и как их располагать на экране, это самая тяжелая операция для браузера. Начинается как выстроено дерево рендера. Расчет размеров начинается с body и идет вниз по дереву. Расчет flex, grid, float. Для построения браузер рекурсивно проходит по DOM, вычисляются стили, вызывается recalculate стадия. Внутри браузера за это отвечает структура render tree, layout tree (style) - внутренняя структура данных C++, которую нельзя изменить извне.

```cpp
class RenderObject {
    private:
        // Reference to the DOM Node being represented
        DOMNode* domNode;

        // Reference to the CSS Styles resolved for this DOM node.
        ComputedStyle* style

        // RenderTree structural pointers
        RenderObject* parent;
        RenderObjectList* children;
}
```

Результатом стадии является точные координаты элементов, ширина и высота. Учитывает параметры шрифта

- Paint - отрисовка каждого отдельного узла или first meaningful paint первая значащая отрисовка. На этапе layout были вычислены данные, а на этапе paint браузер отрисовывает страницу. Отрисовка занимает весь основной поток. Перенос на gpu обеспечивают теги video и canvas, свойства opacity, transform и will-change. Учитывается z-index

- Composite – группировка элементов по слоям, отрисовывает то, что находится не в основном потоке. Все анимации выносятся в отдельный слой, вычисляется в отдельном потоке и JS никак не влияет на него. Послед этого срабатывает событие onload. Теги video и canvas автоматические переносятся в новый слой. С помощью растеризации собираются рендер плитки и GPU отправляет каждый кадр по мере готовности. При отрисовки анимации следует использовать только transform и opacity, что бы не вызывать новый цикл

- Reflow – происходит, когда мы изменяем элементы на экране, могут быть изменены как отдельные ветки, так и все дерево именно поэтому документ должен иметь наиболее плоскую структуру. Так же Reflow происходит когда мы снимаем метрики с помощью getBoundingClientRect, offsetLeft, offsetRight. Reflow происходит в основном потоке браузера, там и где крутится event loop, так что на этой стадии JS будет заблокирован

- Repaint – на этом этапе браузер обходит layout tree и перекрашивает элементы, как правило Reflow вызывает Repaint

- Update вызывается с помощью getBoundingClientRect()

Вызов repaint

- изменение окна, изменение ориентации
- изменение шрифта
- изменение контента, размера
- добавление/удаление классов стилей
- манипуляции с DOM
- вычисление размеров

## критический путь рендеринга

два варианта изменения - взаимодействие с пользователем и JS:

- пользовательский ввод
- прокрутка
- стили из css в dom
- layout который определяется дочерние отношения
- ...

События происходят в одном потоке вместе с js
