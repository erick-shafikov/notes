# Браузер

# Установка соединения

[первая стадия - обмен сообщениями между клиентом-сервером](../../net/interaction.md) за эту часть отвечает network stack, работа происходит через api сокетов

# Получение данных страницы

Процесс браузера - это главный процесс, который отвечает за работу пользовательского интерфейса. Порядок скачивания синхронный, но браузер может распараллелить загрузку разметки с загрузкой js, css. HTML и CSS имеют высокий приоритет, скрипты средний - можно управлять async/defer. Изображения - низкий приоритет, можно менять с помощью link=preload.

# DOM

Токенизация и построение дерева, обработка блокирующих скриптов (без async и defer). Построение дерева может занимать весь поток процесса. Может помочь сканер пред-загрузки. async не будет блокировать выполнения построения dom, defer если порядок важен. CSS не блокирует парсинг HTML, но блокирует JS так как JS может использовать селекторы. Процесс построения DOM устойчив к ошибкам синтаксиса

# CSSOM

независимы друг от друга (DOM и CSSOM). Построение начинается с более общих правил до специфичных. Повторное вычисление стилей (Recalculate Styles) - показатель общее время обработки стилей. Каждый браузер имеет свои предопределенные стили. Браузеры обычно ждут загрузки css

# JS

js после загрузки компилируется, обрабатывается и исполняется. Преобразуется в AST, которое преобразуется в байт-код, который исполняется в основном потоке.

Браузер встречает script type=module src=main.js он рассматривает его как точку входа модуля. По мере импортов формируется граф зависимостей. Запуск каждого модулей осуществляется только после формирования графа зависимостей. Поддерживается динамический импорт. При импорте из библиотек используется script type=importmap, это json-струкутра в которой указываются ссылки не библиотеки и алиасы.

# AOM

дерево доступности - пока не построится контент не готов для голосовых помощников

# отрисовка контента

[Далее проходят стадии отрисовки контента](./painting-stages.md)

# Многопоточность

Все браузеры используют многопоточность. Процессы делятся на основной "процесс браузера" и под-процессы render, gpu, network, расширения, плагинов, служебные. Каждый iframe запускается в отдельном процессе. Каждый процесс запускает в отдельной песочнице для каждого сайта. Процессы общаются через IPC

# Сравнения Chromium, Gecko и WebKit

CSS:

- Blink (Chromium): использует однопоточный движок стилей на C++ (основанный на WebKit)
- Gecko (Firefox): в рамках проекта Quantum (2017) Firefox интегрировал Stylo — новый CSS-движок на Rust с поддержкой многопоточности.
- WebKit (Safari): движок стилей WebKit, как и Blink, однопоточный (Blink отделился от WebKit в 2013 году, до этого архитектура была общей)

Графика:

- WebRender — рендере по умолчанию в Firefox
- В Chrome большая часть растеризации по-прежнему выполняется на CPU, а затем отправляется на GPU в виде битовых карт (bitmaps).
- Safari (WebKit) формирует разметку через слои (называемые CALayer, поскольку на macOS и iOS используется система слоев Core Animation)

JS:

- Chromium, V8 - это Ignition, Sparkplug, TurboFan и Maglev
- Firefox, SpiderMonkey -интерпретатор, Baseline JIT, компилятор IonMonkey
- Safari, JavaScriptCore - LLInt, Baseline, DFG и FTL.

Процессы:

- Chromium - отдельный процесс для каждой вкладки
- Firefox - 8 контент-процессов на все вкладки
- Safari - создает один процесс на вкладку
