# Дерево элементов, fiber

- В React два дерева – дерево элементов и fiber.
- В дереве элементов находится UI. В fiber – находится состояние, пропсы, предыдущие состояния и пропсы, которые позволяют хранит дополнительную информацию о компонентах.

Fiber – связанный лист. JS – объект.

```js
const fiberNode = {
  type: 'div',//Тип узла
  stateNode: DOMNode, //Ссылка на реальный DOM-узел
  child: FiberNode, //Ссылка на первый дочерний узел, если он есть.
  sibling: FiberNode, //Ссылка на следующий узел этого же уровня.
  return: FiberNode, //Ссылка на родительский узел
  effectTag: 'update',//Тип обновления.
  pendingProps: {...},//Пропсы, которые должны быть применены к этому узлу
  memoizedProps: {...}, //Пропсы, которые использовались для рендеринга этого компонента в прошлый раз.
  alternate: FiberNode, //Ссылка на Fiber-узел
  updateQueue: null, //updateQueue
  hooks: null, //Информация о хуках
  index: 0, //Индекс элемента в родительском списке
  nextEffect: FiberNode, //Ссылка на следующий эффект в списке эффектов.
  firstEffect: FiberNode, //Ссылка на первый эффект в списке.
  lastEffect: FiberNode, //Ссылка на последний эффект в списке.
  tag: 'FunctionComponent', //Тип компонента.
  mode: 0 //Режим рендеринга  Concurrent Mode или Strict Mode
}

```

В fiber два типа связи – дочерние и соседские, то есть все элементы знаю о своих родителях и соседях. Самая верхняя node – Host root.

Fiber решил проблему с зависающим рендерингом, то есть при изменении в компоненте, дочернии могли долго рендериться, основные элементы алгоритма:

- Приоритизация задач
- Разбиение рендеринга на чанки
- Асинхронный рендеринг

Каждый элемент производит "работы" - эффекты (запросы данных, подписки, изменение dom), эффекты тоже лист. Все эффекты они приоритизированы. Они делят на два типа деревьев – current tree, а в том, котором происходят изменения VIP-tree. Таким образом есть 2 процесса rendering и reconciliation.

Fiber имеет несколько приоритетов рендеринга:

- Immediate - onChange, onClick
- User-blocking - это анимации, переходы
- Normal - побочные эффекты UseEffect.
- Low
- Idle

Фазы работы fiber:

- Первая фаза: «Эффекты». Reconciliation можно отменить, так как могли произойти изменения во время более ранних изменений. React сравнивает типы элементов и если меняется тип, то элемент и его дочерние элементы демонтируются. Fiber node мутабельные, dom node – иммутабельные
- Вторая фаза «Commit» Здесь выполняются эффекты и меняется дерево элементов, фаза непрерываемая
