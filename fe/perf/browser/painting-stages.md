# парсинг страницы

- Браузер получает HTML-страницу. HTML парсится и разбивается на токены
- Токены преобразуются в ноды
- Ноды собираются в dom DOM (или DOM-дерево) - это представление страницы в памяти компьютера
- Во время прохождения по DOM браузер встречает скрипты и таблицы стилей. Скачиваются все внешние ресурсы
- Параллельно происходит парсинг CSS, выстраивается CSSOM
- CSSOM и DOM объединяются в Render-tree, в котором скрываются невидимые элементы meta, script, link, display:none и добавляются псевдоэлементы before, after
- создается render tree / style calculation «формированием дерева представления» или «формированием дерева рендеринга»
- Переход на стадию Layout, Reflow, Repaint, Composition

# стадии отрисовки страницы

Первая стадия это Layout -> Reflow -> Composition

- **layout** - стадия компоновки, отвечает за определение размеров элементов и как их располагать на экране, это самая тяжелая операция для браузера. Начинается как выстроено дерево рендера. Расчет размеров начинается с body и идет вниз по дереву.

- **Paint** - отрисовка каждого отдельного узла или first meaningful paint первая значащая отрисовка. На этапе layout были вычислены данные, а на этапе paint браузер отрисовывает страницу. Отрисовка занимает весь основной поток. Перенос на gpu обеспечивают теги video и canvas, свойства opacity, transform и will-change.

- **Composite** – группировка элементов по слоям, отрисовывает то, что находится не в основном потоке. Все анимации выносятся в отдельный слой, вычисляется в отдельном потоке и JS никак не влияет на него. Послед этого срабатывает событие onload

- **Reflow** – происходит, когда мы изменяем элементы на экране, могут быть изменены как отдельные ветки, так и все дерево именно поэтому документ должен иметь наиболее плоскую структуру. Так же Reflow происходит когда мы снимаем метрики с помощью getBoundingClientRect, offsetLeft, offsetRight. Reflow происходит в основном потоке браузера, там и где крутится event loop, так что на этой стадии JS будет заблокирован

- **Repaint** – на этом этапе браузер обходит layout tree и перекрашивает элементы, как правило Reflow вызывает Repaint

- **Update** вызывается с помощью getBoundingClientRect()

Вызов repaint

- изменение окна, изменение ориентации
- изменение шрифта
- изменение контента, размера
- добавление/удаление классов стилей
- манипуляции с DOM
- вычисление размеров

# blink

все что касается отрисовки контента за это отвечает движок Blink в Chrome. В обязанности входит:

- реализация спеки HTML
- css и web idl
- интеграция V8 (запуск js)
- отрисовка графики Skia
- сетевые запросы
- выстраивание DOM CSSOM Render tree
- Chrome compositor (CC)

## Chrome compositor

механизм отрисовки. Оперирует деревом слоев. Состоит из:

- Compositor thread - планировщик задач

Все операции проходят в несколько потоков, выделяют:

- Main thread - здесь составляются RenderTree и LayerTreeHost, обработка JS. Он сообщает что страница готова к отрисовке, стремится к 1000/60

CC подает сигнал на отрисовку страницы. Кадры могут быть отклонены
